<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="postingMapper">

	<resultMap type="Posting" id="PostingResultSet">
		<result property="postingNo" column="POSTING_NO"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="categoryNo" column="CATEGORY_NO"/>
		<result property="productInfo" column="PRODUCT_INFO"/>
		<result property="productName" column="PRODUCT_NAME"/>
		<result property="endTime" column="END_TIME"/>
		<result property="startTime" column="START_TIME"/>
		<result property="startPrice" column="START_PRICE"/>
		<result property="bidUnit" column="BID_UNIT"/>
		<result property="status" column="STATUS"/>
	</resultMap>

	<resultMap type="MainPagePosting" id="MainPagePostingResultSet">
		<result property="postingNo" column="POSTING_NO"/>
		<result property="productName" column="PRODUCT_NAME"/>
		<result property="maxPrice" column="MAX_PRICE"/>
		<result property="bidCount" column="BID_COUNT"/>
		<result property="endTime" column="END_TIME"/>
		<result property="imgFile" column="IMG_FILE"/>
	</resultMap>

	<insert id="insertPosting" useGeneratedKeys="true" keyProperty="postingNo" keyColumn="POSTING_NO">
		INSERT INTO POSTING (
			MEM_NO, CATEGORY_NO, PRODUCT_INFO, PRODUCT_NAME,
			END_TIME, START_TIME, START_PRICE, BID_UNIT, STATUS
		)
		VALUES (
			#{memNo}, #{categoryNo}, #{productInfo}, #{productName},
			STR_TO_DATE(#{endTime}, '%Y-%m-%dT%H:%i'), NOW(), #{startPrice}, #{bidUnit}, 'BID'
		)
	</insert>

	<select id="selectPosting" resultMap="PostingResultSet">
		SELECT
			POSTING_NO, MEM_NO, CATEGORY_NO, PRODUCT_INFO,
			PRODUCT_NAME, END_TIME, START_TIME,
			START_PRICE, BID_UNIT, STATUS
		FROM POSTING
		WHERE POSTING_NO = #{postingNo} AND STATUS = 'BID'
	</select>

	<select id="selectPostingList" resultMap="MainPagePostingResultSet">
		SELECT
			p.POSTING_NO,
			p.PRODUCT_NAME,
			COALESCE(MAX(b.BID_PRICE), p.START_PRICE) AS MAX_PRICE,
			COUNT(b.BID_NO) AS BID_COUNT,
			p.END_TIME,
			i.IMG_FILE
		FROM POSTING p
		LEFT JOIN BID b ON p.POSTING_NO = b.POSTING_NO
		JOIN IMAGE i ON p.POSTING_NO = i.POSTING_NO 
		            AND i.IMG_NO = (SELECT MIN(IMG_NO) FROM IMAGE WHERE POSTING_NO = p.POSTING_NO)
		GROUP BY
			p.POSTING_NO, p.PRODUCT_NAME, p.END_TIME,
			i.IMG_FILE, p.START_TIME, p.START_PRICE
		ORDER BY p.START_TIME DESC
	</select>

	<select id="selectTopPostingList" resultMap="MainPagePostingResultSet">
		SELECT
			p.POSTING_NO,
			p.PRODUCT_NAME,
			COALESCE(MAX(b.BID_PRICE), p.START_PRICE) AS MAX_PRICE,
			COUNT(b.BID_NO) AS BID_COUNT,
			p.END_TIME,
			i.IMG_FILE
		FROM POSTING p
		LEFT JOIN BID b ON p.POSTING_NO = b.POSTING_NO
		JOIN IMAGE i ON p.POSTING_NO = i.POSTING_NO 
		            AND i.IMG_NO = (SELECT MIN(IMG_NO) FROM IMAGE WHERE POSTING_NO = p.POSTING_NO)
		GROUP BY
			p.POSTING_NO, p.PRODUCT_NAME, p.END_TIME,
			i.IMG_FILE, p.START_TIME, p.START_PRICE
		ORDER BY BID_COUNT DESC
		LIMIT 4
	</select>

	<select id="selectSearchList" resultMap="MainPagePostingResultSet">
		SELECT
			p.POSTING_NO,
			p.PRODUCT_NAME,
			COALESCE(MAX(b.BID_PRICE), p.START_PRICE) AS MAX_PRICE,
			COUNT(b.BID_NO) AS BID_COUNT,
			p.END_TIME,
			i.IMG_FILE
		FROM POSTING p
		LEFT JOIN BID b ON p.POSTING_NO = b.POSTING_NO
		JOIN IMAGE i ON p.POSTING_NO = i.POSTING_NO 
		            AND i.IMG_NO = (SELECT MIN(IMG_NO) FROM IMAGE WHERE POSTING_NO = p.POSTING_NO)
		WHERE p.PRODUCT_NAME LIKE CONCAT('%', #{keyword}, '%')
		GROUP BY
			p.POSTING_NO, p.PRODUCT_NAME, p.END_TIME,
			i.IMG_FILE, p.START_TIME, p.START_PRICE
		ORDER BY p.START_TIME DESC
	</select>

	<select id="selectMyPostingList" resultMap="MainPagePostingResultSet">
		SELECT
			p.POSTING_NO,
			p.PRODUCT_NAME,
			COALESCE(MAX(b.BID_PRICE), p.START_PRICE) AS MAX_PRICE,
			COUNT(b.BID_NO) AS BID_COUNT,
			p.END_TIME,
			i.IMG_FILE
		FROM POSTING p
		LEFT JOIN BID b ON p.POSTING_NO = b.POSTING_NO
		JOIN IMAGE i ON p.POSTING_NO = i.POSTING_NO 
		            AND i.IMG_NO = (SELECT MIN(IMG_NO) FROM IMAGE WHERE POSTING_NO = p.POSTING_NO)
		WHERE p.MEM_NO = #{memNo}
		GROUP BY
			p.POSTING_NO, p.PRODUCT_NAME, p.END_TIME,
			i.IMG_FILE, p.START_TIME, p.START_PRICE
		ORDER BY p.START_TIME DESC
	</select>

</mapper>